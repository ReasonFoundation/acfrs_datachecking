---
title: "Data Summary Statistics"
date: June 11, 2022
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(dplyr)
library(purrr)
library(kableExtra)
```

# Data Overview

##ACFRS Data
Data was downloaded from website on Jan 11. Filtered out "Non-profit" category

```{r}
options(scipen=999)
jan11_site <- rio::import(here::here("data", "CAFRdata_20220111_221828.xlsx"))
jan11_site %>% 
  filter(Category != "Non-Profit") %>% 
  select(State, Entity, Category,
    `Net Pension Liability`, `Net OPEB Assets`, `Net OPEB Liability`, `Bonds Outstanding`, `Notes Outstanding`, 
     Leases, `Loans Outstanding`, `Compensated Absences`, `Total Liabilities`, Revenues) -> d
head(d)

```


# Grand total of each field
```{r}
d %>% 
  select_if(is.numeric) %>% 
  map_dbl(sum)

```
# Total of each field by states 

See full data in the csv file attached. 
```{r}
options(scipen=999)
sum_state <- d %>% 
  select(-c(Entity, Category)) %>% 
  group_by(State) %>% 
  mutate(sum_state_netPensionLiability = sum(`Net Pension Liability`),
         sum_state_netOEPAssets = sum(`Net OPEB Assets`),
         sum_state_netOPEBliability = sum(`Net OPEB Liability`), 
         sum_state_bondOustanding = sum(`Bonds Outstanding`), 
         sum_state_noteOutstanding = sum(`Notes Outstanding`), 
         sum_state_leases = sum(Leases), 
         sum_state_loansOutstanding = sum(`Loans Outstanding`), 
         sum_state_compensatedAbsences = sum(`Compensated Absences`), 
         sum_state_totalLiabilities = sum(`Total Liabilities`), 
         sum_state_revenues = sum(Revenues)
         ) %>% 
  select(-c(2:11)) %>% distinct()

#write_csv(sum_state, "sum_by_state.csv")
sum_state %>% head()

```
# Top 10 entities with highest ratio of field value/ revenues 

Note: Filtered out all rows with revenues = 0

### `Net OPEB Liability`
```{r}
  d %>% 
      filter(Revenues != 0) %>% 
      select(State, Entity, `Net OPEB Liability`, Revenues) %>% 
      mutate(ratio = `Net OPEB Liability`/Revenues) %>% 
      arrange(desc(ratio)) %>% 
      slice(1:10)
  
```
### `Bonds Outstanding`
```{r}

  d %>% 
      filter(Revenues != 0) %>% 
      select(State, Entity, `Bonds Outstanding`, Revenues) %>% 
      mutate(ratio = `Bonds Outstanding`/Revenues) %>% 
      arrange(desc(ratio)) %>% 
      slice(1:10)

```
### `Notes Outstanding`
```{r}

  d %>% 
      filter(Revenues != 0) %>% 
      select(State, Entity, `Notes Outstanding`, Revenues) %>% 
      mutate(ratio = `Notes Outstanding`/Revenues) %>% 
      arrange(desc(ratio)) %>% 
      slice(1:10)
```
### Leases

```{r}

  d %>% 
      filter(Revenues != 0) %>% 
      select(State, Entity, Leases, Revenues) %>% 
      mutate(ratio = Leases/Revenues) %>% 
      arrange(desc(ratio)) %>% 
      slice(1:10)
```
### `Loans Outstanding`
```{r}

  d %>% 
      filter(Revenues != 0) %>% 
      select(State, Entity, `Loans Outstanding`, Revenues) %>% 
      mutate(ratio = `Loans Outstanding`/Revenues) %>% 
      arrange(desc(ratio)) %>% 
      slice(1:10)
```
### `Compensated Absences`
```{r}

  d %>% 
      filter(Revenues != 0) %>% 
      select(State, Entity, `Compensated Absences`, Revenues) %>% 
      mutate(ratio = `Compensated Absences`/Revenues) %>% 
      arrange(desc(ratio)) %>% 
      slice(1:10)
```
### `Total Liabilities`
```{r}
  d %>% 
      filter(Revenues != 0) %>% 
      select(State, Entity, `Total Liabilities`, Revenues) %>% 
      mutate(ratio = `Total Liabilities`/Revenues) %>% 
      arrange(desc(ratio)) %>% 
      slice(1:10)
```
# Top 10 values in each field 

```{r}
#fields <- c("Net Pension Liability", "Net OPEB Assets", "Net OPEB Liability", "Bonds Outstanding", "Notes Outstanding", 
 #    "Leases", "Loans Outstanding", "Compensated Absences", "Total Liabilities", "Revenues")
length(state_abb$State)
```


```{r}
# biggest Loans

# for (field in fields) {
# top_field <- d %>% 
#   select(State, Entity, field) %>% 
#   arrange(desc(field)) %>% 
#   slice(1:10)
# 
# print(top_field)
# 
# }

d %>% 
  select(State, Entity, `Net Pension Liability`) %>% 
  arrange(desc(`Net Pension Liability`)) %>% 
  slice(1:10) %>% 
  kbl() %>% 
  kable_paper("hover", full_width = F)
```


```{r}
d %>% 
  select(State, Entity, `Net OPEB Assets`) %>% 
  arrange(desc(`Net OPEB Assets`)) %>% 
  slice(1:10)

```

```{r}
d %>% 
  select(State, Entity, `Net OPEB Liability`) %>% 
  arrange(desc(`Net OPEB Liability`)) %>% 
  slice(1:10)

```

     
```{r}
d %>% 
  select(State, Entity, `Bonds Outstanding`) %>% 
  arrange(desc(`Bonds Outstanding`)) %>% 
  slice(1:10)
```
     
```{r}
d %>% 
  select(State, Entity, `Notes Outstanding`) %>% 
  arrange(desc(`Notes Outstanding`)) %>% 
  slice(1:10)
```

```{r}
d %>% 
  select(State, Entity, `Leases`) %>% 
  arrange(desc(`Leases`)) %>% 
  slice(1:10)
```

```{r}
d %>% 
  select(State, Entity, `Loans Outstanding`) %>% 
  arrange(desc(`Loans Outstanding`)) %>% 
  slice(1:10)
```


```{r}
d %>% 
  select(State, Entity, `Compensated Absences`) %>% 
  arrange(desc(`Compensated Absences`)) %>% 
  slice(1:10)
```


```{r}
d %>% 
  select(State, Entity, `Total Liabilities`) %>% 
  arrange(desc(`Total Liabilities`)) %>% 
  slice(1:10)
```

```{r}
d %>% 
  select(State, Entity, `Bonds Outstanding`) %>% 
  arrange(desc(`Bonds Outstanding`)) %>% 
  slice(1:10)
```

```{r}
d %>% 
  select(State, Entity, `Revenues`) %>% 
  arrange(desc(`Revenues`)) %>% 
  slice(1:10)
```


# Compare with Census Data

## Read in census data

The Census Bureau has national and state debt totals here:
https://www2.census.gov/programs-surveys/gov-finances/tables/2019/19slsstab1a.xlsx
and here:
https://www2.census.gov/programs-surveys/gov-finances/tables/2019/19slsstab1b.xlsx.

The excel files has 5 components for each state. The column used below is "state & local government amount"

```{r}
# first half
census_debta <- rio::import(here::here("data", "19slsstab1a.xlsx"), skip = 9)
state_local_amount1 <- census_debta %>% filter(`...1` == "125") %>% 
  pivot_longer(3:132,
               names_to = "State",
               values_to = "debt_outstanding_census") %>% 
  select(3:4) %>% 
  filter(!grepl("\\...", State)) 

#second half

census_debtb <- rio::import(here::here("data", "19slsstab1b.xlsx"), skip = 9)

state_local_amount2 <- census_debtb %>% 
filter(`...1` == "125") %>% 
  pivot_longer(3:132,
               names_to = "State",
               values_to = "debt_outstanding_census") %>% 
  select(3:4) %>% 
  filter(!grepl("\\...", State))

# joining 
state_local_amount_census <- rbind(state_local_amount1, state_local_amount2) 

state_local_amount_census

```

Getting state.abb column 
```{r}

left_join(state_local_amount_census, state_abb)
state_name_abb <- data.frame(state.abb, state.name) %>% 
  rename("Name" = state.name)

dc <- c("DC", "District of Columbia")

rbind(dc, state_name_abb) %>% 
  arrange(Name) -> foo1


state_local_amount_census %>% 
  filter(State != "United States Total") %>% 
  arrange(State) -> foo2

debt_outstanding_census <- cbind(foo1, foo2) %>% select(-State) %>% 
  rename("State" = state.abb)
```

Compute sum of `Bonds Outstanding`, `Notes Outstanding`, Leases by state

```{r}
d %>% 
  select(State, `Bonds Outstanding`, `Notes Outstanding`, Leases) %>% 
  mutate(sum_bonds_notes_leases = `Bonds Outstanding` + `Notes Outstanding` + Leases) %>% 
  select(State, sum_bonds_notes_leases) %>% 
  group_by(State) %>% 
  mutate(state_sum_bonds_notes_leases = sum(sum_bonds_notes_leases)) %>% 
  select(-sum_bonds_notes_leases) %>% distinct() -> acfrs_debt
  acfrs_debt
```

```{r}
acfrs_debt %>% 
  left_join(debt_outstanding_census) %>% 
  mutate(ratio = state_sum_bonds_notes_leases - debt_outstanding_census)

debt_outstanding_census %>% 
  as_tibble()  %>% 
  as.double(debt_outstanding_census)
map_dbl(sum)
```

