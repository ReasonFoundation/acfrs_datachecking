---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(writexl)
```

```{r}
data_jan4 <- rio::import(here::here("data", "data-jan4.csv")) 
# data dimension 
dim(data_jan4)
head(data_jan4)
data_jan4a <- data_jan4 %>% select(-total_revenues)
```

```{r}
summary(data_jan4)
```

Cases where total_revenues = charges_for_services + operating_grants + capital_grants + general_revenue

Who tends to have 4-components total revenues? (certain population size)
```{r}
data_jan4a %>% 
  #calculating total_revenues new way 

  mutate(total1 = (`Operating Grants and Contributions` + `Capital Grants and Contributions` + `Charges for Services`+
         `General Revenue`)) %>% 
  mutate(total2 = (Expenses + `Change in Net Position`)) %>% 
  mutate(total3 = (`Total Operating Revenues` + `Non-Operating Revenues`)) %>% select(Entity, total1, total2, total3) %>% 
  mutate(total_revenues = pmax(total1,total2,total3 )) %>% 
  
  
  
  mutate(total_revenues_4 = charges_for_services + operating_grants + capital_grants + general_revenue) %>% 
  mutate(comparison = ifelse(total_revenues == total_revenues_4, "T", "F")) %>% 
  filter(comparison == "T") %>% 
  select(state, name, total_revenues, total_revenues_4, comparison)  
  
```
```{r}
data_jan4 %>% 
  mutate(total_revenues_4 = charges_for_services + operating_grants + capital_grants + general_revenue) %>% 
  mutate(comparison = ifelse(total_revenues == total_revenues_4, "T", "F")) %>% 
  filter(comparison == "F") %>% 
  filter(total_revenues_4 !=0) %>% 
  #select(state, name, total_revenues, total_revenues_4, comparison)  %>% 
    mutate(total_revenues_3 = total_operating_revenues + non_operating_revenues + capital_contributions) %>% 
  mutate(comparison = ifelse(total_revenues == total_revenues_3, "T", "F")) %>% 
  filter(comparison == "F")
```

Cases where total_revenues = total_operating_revenues + non_operating_revenues + capital_contributions

Who tends to have 3-components total revenues? 

```{r}
data_jan4 %>% 
  mutate(total_revenues_3 = total_operating_revenues + non_operating_revenues + capital_contributions) %>% 
  mutate(comparison = ifelse(total_revenues == total_revenues_3, "T", "F")) %>% 
  filter(comparison == "T") %>% 
  select(state, name, total_revenues, total_revenues_3, comparison)  
```
# total_liabilities 

## Top 10 Entities with big ratio
```{r}
data_jan4 %>% 
  mutate(big_ratio = total_liabilities/total_revenues) %>% 
  arrange(desc(big_ratio)) %>% slice(1:10)
```
Sanitary and Improvement District No. 588 of Douglas County not found

Seminole County Educational Facilities Authority, correct

## Top 10 entities with big ratio who are not special district

```{r}
data_jan4 %>% 
  mutate(big_ratio = total_liabilities/total_revenues) %>% 
  filter(category != "Special District") %>% 
  arrange(desc(big_ratio)) 

# these are checked by Marc
School District of the City of Inkster
Forester Township
Elwood
Detroit City School District
Muskegon Heights School District
Mojave River Academy
Building Hope Finance Formerly Building Hope... A Charter School Fac
Jamestown
Vinton

```
```{r}
all <- rio::import(here::here("data", "CAFRdata_20220106_224259.xlsx"))
colnames(all)

all %>% 
  filter(Entity == "East New Market") %>% select(Revenues) # correct value 113225	

# the biggest value is "correct one"
all %>% 
  mutate(total1 = (`Operating Grants and Contributions` + `Capital Grants and Contributions` + `Charges for Services`+
         `General Revenue`)) %>% 
  mutate(total2 = (Expenses + `Change in Net Position`)) %>% 
  mutate(total3 = (`Total Operating Revenues` + `Non-Operating Revenues`)) %>% 
  
  mutate(total_revenues = pmax(total1,total2,total3 )) %>% 
 # filter(Entity == "East New Market") %>% 
  mutate(ratio = `Total Liabilities`/total_revenues) %>% 
  filter(ratio > 8)

```


GREATEST(expenses + change_in_net_position, charges_for_services + operating_grants + capital_grants + general_revenue, total_operating_revenues + non_operating_revenues) AS total_revenues


# components

select cafrs_state.abbreviation as state, cafrs_entity.name, cafrs_entity.category,

total_liabilities, bonds_outstanding, compensated_absences, leases, loans_outstanding, notes_outstanding,

net_pension_liability - net_pension_assets as pension_debt,

net_opeb_liability - net_opeb_assets as opeb_debt,

charges_for_services + operating_grants + capital_grants + general_revenue + total_operating_revenues + non_operating_revenues + capital_contributions as total_revenues,

charges_for_services, operating_grants, capital_grants, general_revenue, total_operating_revenues, non_operating_revenues, capital_contributions

from cafrs_entity

inner join cafrs_state on (cafrs_entity.state_id = cafrs_state.id)

inner join cafrs_cafr on (cafrs_cafr.entity_id = cafrs_entity.id)

inner join cafrs_netposition on (cafrs_cafr.id = cafrs_netposition.cafr_id)

inner join cafrs_activities on (cafrs_cafr.id = cafrs_activities.cafr_id)

inner join cafrs_proprietaryrevenues on (cafrs_cafr.id = cafrs_proprietaryrevenues.cafr_id)

where category <> 'Non-Profit'

and cafrs_cafr.year = 2020

and not is_nonstandard

and is_valid

and reviewed_date is not null

and charges_for_services + operating_grants + capital_grants + general_revenue+ total_operating_revenues + non_operating_revenues + capital_contributions > 0

and total_liabilities / greatest(charges_for_services + operating_grants + capital_grants + general_revenue+ total_operating_revenues + non_operating_revenues + capital_contributions, 1) > 8