---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## R Markdown

```{r}
all <- rio::import(here::here("data", "CAFRdata_20220106_224259.xlsx"))

# the biggest value is "correct one"
all_total_revenues <- all%>% 
  #Simmesport Volunteer Fire Department, inc --> should be special district
  filter(Category != "Non-Profit") %>% 
  mutate(total1 = (`Operating Grants and Contributions` + `Capital Grants and Contributions` + `Charges for Services`+
         `General Revenue`)) %>% 
  mutate(total2 = (Expenses + `Change in Net Position`)) %>% 
  mutate(total3 = (`Total Operating Revenues` + `Non-Operating Revenues`)) %>% 
  mutate(total_revenues = pmax(total1,total2,total3 ))
  
all_total_revenues %>% 
  mutate(ratio_totLiab_totReve = `Total Liabilities`/total_revenues) %>% 
  # filter(ratio > 8) %>% 
  filter(Category != "Special District") %>% 
  arrange(desc(ratio_totLiab_totReve)) %>% 
 # filter(Entity == "Simmesport Volunteer Fire Department, inc") %>% 
 # filter(Entity == "Todd County School District No. 66-1") %>% 
  select(State, Entity, total_revenues, `Total Liabilities`, ratio_totLiab_totReve)

all_total_revenues %>% 
  filter(Entity == "Westlake") %>% select(total1, total2, total3, total_revenues)

```



#check next:
  University of Central Arkansas
  Proprietary Revenues missing
  Todd County School District No. 66-1
  current number 406,669,978 --> should be: 4,006,699.78  
  
# Test 2: total_liabilities >= sum of components()
  
```{r total_liabilities >= sum of components}

all_total_revenues %>% 
  filter(Category != "Non-Profit") %>% 
  mutate(sum_components = `Bonds Outstanding` + `Compensated Absences` + Leases +
           `Loans Outstanding` + `Net Pension Liability` + `Net OPEB Liability`) %>% 
  mutate(ratio_sumComponents_totLiab = round(sum_components/(`Total Liabilities` + 1))) %>% 
  mutate(sum_components_bigger = ifelse(sum_components - `Total Liabilities` > 0, "Y", "N")) %>% 
  filter(sum_components_bigger == "Y") -> result2

result2 %>% 
  select(State, Entity, `Total Liabilities`, ratio_sumComponents_totLiab, sum_components) %>% 
  filter(`Total Liabilities` != 0) %>% arrange(desc(ratio_sumComponents_totLiab)) 


```
Checked the first 11; correct: Milford, Waverly, Greenbrier School District No. 47

AR, Ouachita School District: correct tot_lia, bonds outstanding; not found in pdf: expenses, general revenue
AR: often not follow general standard

#  Test 3: total_revenues/ population highest

```{r}
pop <- rio::import(here::here("data", "population.csv")) %>% rename("State" = abbreviation, "Entity" = name)
colnames(pop)
```

```{r}
# join with population data , checking highest ratio total_revenues/population

all_total_revenues_pop <- all_total_revenues %>% 
full_join(pop) %>% 
  mutate(ratio_totRevenues_pop = total_revenues/population) %>% 
  select(State, Entity, ratio_totRevenues_pop, population, total_revenues, `Total Liabilities`, `Bonds Outstanding`,  `Compensated Absences`, Leases, `Loans Outstanding`, `Net Pension Liability`, `Net OPEB Liability`) %>% 
  filter(!is.na(ratio_totRevenues_pop)) %>% arrange(desc(ratio_totRevenues_pop)) %>% slice(1:20)
```
checked Jan 10 :
CA, Vernon
CA, Industry
FL, Westlake. Expenses in pdf put () sign but cafr site not putting - sign (correct use absolute values)
VA, Washington County

Emailed to Ram:
AL, Washington County: Total Liabilities currently 1,409,442,264 --> should be 14,094,422.64 (NOTE: found this by accident, no specific criteria)

OK, Francis, Change in Net Posision -4.768 --> should be 503, 870? (p.6) Can't find -4,768 anywhere in the pdf file


# Others:
Population of NY, Rochester should be bigger than 7220

```{r}

all_total_revenues_pop %>% 
  filter(Entity == "Francis")
```


























