---
title: "Matching ACFRs School Districts with NCES Student Enrollment"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(tidyr)
library(dplyr)
library(threadr)

```

```{r}
rio::import
```

# Read in Data 

```{r nces_school_districts}
state_name_df <- tibble(state.name, state.abb) %>% rename(state = state.abb)
#data downloaded Jan 27, 2020. Not including charter schools. Student > 1. Total 13,713
nces <- rio::import(here::here("data", "ncesdata_DBBFFFC.xlsx"), skip = 14) %>% 
  select(`NCES District ID`, `State District ID`, `District Name`, `County Name*`, City, State, `Students*`) %>% 
  rename(nces_original_name = `District Name`,
    county = `County Name*`, 
    state = State, 
    student = `Students*`) %>% 
  mutate(name = str_to_lower(nces_original_name)) %>% drop_na(name)

```

```{r}
# acfrs from database, # only get School District, total 9478

acfrs_school_districts <- readRDS("data_from_dbsite.RDS") %>% 
  rename(acfrs_original_name = name) %>% 
  filter(category == "School District") %>% 
  mutate(name = str_to_lower(acfrs_original_name)) %>% drop_na(name) %>% 

mutate(ratio = total_liabilities/revenues) %>% arrange(desc(ratio)) %>% 
  filter(!is.na(ratio)) %>% 
  slice(-c(1:4)) %>% 
  mutate(ratio_group = case_when(ratio >= 10 ~ "Above 10%",
                                 ratio >= 5 ~ "5 - 10%",
                                 ratio >= 1 ~ "1 - 5%",
                                 ratio < 1 ~ " Below 1%")) %>% 
arrange(acfrs_original_name) %>% left_join(state_name_df)

```


# Example of 63 School Districts

This is a hand-matched example of 63 school district in NCES data & ACFRs. (Thank you! Marc)

Analyzing the pattern of match between these 2 datasets will help improving match in the full datasets. 

```{r}
example_match_60sd <- rio::import(here::here("data", "Mappings for Largest School Districts (2).xlsx")) %>% 
  rename(name = `Name in ACFR System`, 
         nces_name = `District Name`) %>% 
  select(name, nces_name, `State District ID`, `State...7`) 

example_match_60sd_clean <- example_match_60sd %>% 
   mutate(nces_name = str_to_lower(nces_name),
         name = str_to_lower(name)) %>% 
  
  # remove terms in acfrs, 1st time
  mutate(name = str_remove_all(name, "(the)?\\s*school district\\s*(of)?|county|independent school district|district school board|\\s*board of education\\s* (of the)?|public schools|the school board of|board of education|public school system")) %>% 

  # remove terms in acfrs, second time
  mutate(name = str_trim(name, side = "both")) %>% 
  mutate(name = str_remove_all(name, "^of\\s*|-$|municipalno.*|\\.|'s|’s|[0-9]*$")) %>% 
  mutate(name = str_trim(name, side = "both")) %>% # need to repeat b/c after removing words, space remains
  
  
  # remove terms in nces, 1st time
  mutate(nces_name = str_remove_all(nces_name, "(the)?\\s*school district\\s*(of)?|independent school district|district( school board)?|board of education|isd|public schools|schools|(co)? pblc schs|county|(city )?sd")) %>% 
  
  # remove terms in nces, 2nd time
  
  mutate(nces_name = str_trim(nces_name, side = "both")) %>% 
  mutate(nces_name = str_remove_all(nces_name, "^of\\s*|-$|municipalno.*|\\.|'s|’s|[0-9]*$")) %>% 
  mutate(nces_name = str_trim(nces_name, side = "both")) 
  

example_matched <- example_match_60sd_clean %>% 
  # check of the 2 name cols are identical
  mutate(same_name = ifelse(name == nces_name, TRUE, FALSE)) %>% 
  filter(same_name == TRUE)

examples_NOT_matched <- example_match_60sd_clean %>% 
  # check of the 2 name cols are identical
  mutate(same_name = ifelse(name == nces_name, TRUE, FALSE)) %>% 
  filter(same_name == FALSE)

```


# ACFRs data - School District

```{r}
options(scipen = 999)
acfrs_school_districts_clean <- acfrs_school_districts %>% 
  # remove terms in acfrs, 1st time
  mutate(name = str_remove_all(name, "(the)?\\s*school district\\s*(of)?|county|independent school district|district school board|\\s*board of education\\s* (of the)?|public schools|the school board of|board of education|public school system")) %>% 

  # remove terms in acfrs, second time
  mutate(name = str_trim(name, side = "both")) %>% 
  mutate(name = str_remove_all(name, "^of\\s*|-$|municipalno.*|\\.|'s|’s|[0-9]*$")) %>% 
  mutate(name = str_trim(name, side = "both")) %>%  arrange(name) %>% 

  # some names got trimmed off using above regular expression, need to add back here. 
  mutate(name = ifelse(name == "" | name == "#", acfrs_original_name, name)) %>% 
  
   # change some names: "City of Chicago SD 299" in NCES is "Chicago Board of Education" in Acfrs 
  mutate(name = ifelse(acfrs_original_name == "Chicago Board of Education", "chicago board of education", name),
         name = str_squish(name)) 

write_csv(acfrs_school_districts_clean, "acfrs_school_districts_clean.csv")
```

```{r}
nces_clean <- nces %>% select(-c(`State District ID`, City)) %>% 
  left_join(state_name_df) %>% select(-state) %>% rename(state = state.name) %>% 
  # remove terms in nces, 1st time
  mutate(name = str_remove_all(name, "(the)?\\s*school district\\s*(of)?|independent school district|district( school board)?|board of education|isd|public schools|schools|(co)? pblc schs|county|(city )?sd")) %>% 
  
  # remove terms in nces, 2nd time
  
  mutate(name = str_trim(name, side = "both")) %>% 
  mutate(name = str_remove_all(name, "^of\\s*|-$|municipalno.*|\\.|'s|’s|[0-9]*$")) %>% 
  mutate(name = str_trim(name, side = "both")) %>% arrange(name) %>% slice(-c(1:1)) %>%  
mutate(name = str_squish(name)) %>% 
# Marc: "City of Chicago SD 299" in NCES is "Chicago Board of Education" in Acfrs 
mutate(name = ifelse(nces_original_name == "City of Chicago SD 299", "chicago board of education", name)) 
  
```


# Matching over all first time

```{r}
# include all, NOT drop_na - some sd have same names got matched multiple times --> raising the total number
all_acfrs_nces_sd <- acfrs_school_districts_clean %>% 
  left_join(nces_clean) %>% 
  mutate(student = as.numeric(student)) %>% 
  arrange(desc(student)) %>% 
  select(-c(census_id, category, has_unconfirmed)) %>% distinct()
  
matched_acfrs_nces_sd <- all_acfrs_nces_sd %>% drop_na(student) 

saveRDS(all_acfrs_nces_sd, "sd_nces_all.RDS")
# write.csv(matched_acfrs_nces_sd, "matched_acfrs_nces_sd_withID.csv")
#saveRDS(matched_acfrs_nces_sd, "matched_acfrs_nces_sd.RDS")
write_csv(matched_acfrs_nces_sd, "matched_acfrs_nces_sd.csv")
  
# After the first time, these are left unmatched: 9670 total - 4970 = 4600 NOT matched
all_acfrs_nces_sd %>% filter(is.na(student)) %>% 
  count(state) %>% select(state, n) %>% arrange(desc(n)) 

round1_acfrs_leftover <- acfrs_school_districts %>% filter(!acfrs_school_districts$acfrs_original_name %in% matched_acfrs_nces_sd$acfrs_original_name)
                                           
round1_nces_leftover <- nces %>% filter(!nces$nces_original_name %in% matched_acfrs_nces_sd$nces_original_name) #8694
```

```{r}
# Count how many sd in each state
acfrs_sd_count <- acfrs_school_districts_clean %>% 
  count(state) %>% rename(acfrs_sd_count = n)

nces_as_count <- nces_clean %>% 
  count(state) %>% rename(nces_sd_count = n)

# count leftover after 1 round
round1_acfrs_leftover %>% count(state) %>% arrange(desc(n))

```

NCES name = ACFRs name
HSD = High School District
CHSD = Community High School District
CUSD = Community Unit School District

CCSD = Community Consolidated School District
Spec Educ Coop = Special Education Cooperative
ROE = Regional Office of Education
sd = public schools district
USD = School District

UD =  Consolidated School District ??
# Second round matching

## Illinois
```{r}
illinois_acfrs <- round1_acfrs_leftover %>% filter(state == "Illinois") %>% select(acfrs_original_name, name) %>% 
  mutate(name = str_remove_all(name, "no.|#")) %>% 
  mutate(name = str_replace_all(name, "\\.", " ")) %>% 
  mutate(name = str_replace_all(name, "-", " ")) %>%
  mutate(name = str_replace_all(name, "community consolidated school district", "ccsd"),
         name = str_replace_all(name, "community consolidated schools district", "ccsd")) %>% 
  mutate(name = str_replace_all(name, "community high school district", "chsd"),
    name = str_replace_all(name, "high school district", "hsd")) %>% 
  
mutate(name = str_replace_all(name, "community unit school district", "cusd"),
       name = str_replace_all(name, "community unit schools district", "cusd"),
       name = str_replace_all(name, "community school district", "csd")) %>% 
mutate(name = str_replace_all(name, "special education cooperative", "spec educ coop")) %>% 
mutate(name = str_replace_all(name, "regional office of education", "roe"),
       name = str_replace_all(name, "township", "twp"),
       name = str_replace_all(name, "public school district", "sd"),
       name = str_replace_all(name, "public schools district", "sd"),
       name = str_replace_all(name, "elementary school district", "esd")) %>% 
  mutate(name = str_replace_all(name, "school district", "sd")) %>%  # keep this after the above
  

# Special cases
mutate(name = str_replace(name, "chicago board of education", "city of chicago sd 299")) %>% 
mutate(name = str_squish(name)) 

illinois_acfrs %>% select(acfrs_original_name, name)


```


```{r}
illinois_nces <- round1_nces_leftover %>% select(-c(`State District ID`, City)) %>% 
  left_join(state_name_df) %>% select(-state) %>% rename(state = state.name) %>% filter(state == "Illinois") %>% 
  mutate(name = str_squish(name)) %>% 
  
  mutate(name = str_replace_all(name, "comm sch dist", "csd")) %>% 
  
  mutate(name = str_replace_all(name, "-", " ")) %>%
  select(nces_original_name, name, student)

# second round NCES ~ ACFRS
#usd ~ sd

# NOTE: NCES has only few ROE vs ACFRs has 33
```

```{r}
illinois_round2 <- illinois_acfrs %>% left_join(illinois_nces) %>% drop_na(student) #%>% write_csv("matched_acfrs_necs_Illinois.csv")

illinois_round2_acfrs_leftover <- illinois_acfrs %>% filter(!illinois_acfrs$acfrs_original_name %in% illinois_round2$acfrs_original_name)
illinois_round2_nces_leftover <- illinois_nces %>% filter(!illinois_nces$nces_original_name %in% illinois_round2$nces_original_name)

illinois_round3_acfrs <- illinois_round2_acfrs_leftover %>% 
  mutate(name = str_replace_all(name, " sd", " usd")) 

```

```{r}
illinois_round3_acfrs %>% left_join(illinois_round2_nces_leftover) %>% drop_na(student)

```


# Oklahoma
```{r}
acfrs_oklahoma <- acfrs_school_districts %>% filter(state == "Oklahoma") %>% select(acfrs_original_name, name) %>%
  mutate(name = str_remove_all(name, "school district.*"), 
         name = str_squish(name))

nces_oklahoma <- nces %>% select(-c(`State District ID`, City)) %>% 
  left_join(state_name_df) %>% select(-state) %>% rename(state = state.name) %>% filter(state == "Oklahoma") %>% 
  mutate(name = str_squish(name)) %>% 
  select(nces_original_name, name, student)  

acfrs_oklahoma %>% left_join(nces_oklahoma) %>% drop_na(student)
```

# Michigan

```{r}
michigan_acfrs <- acfrs_school_districts %>% filter(state == "Michigan") %>% select(acfrs_original_name, name) %>%
  mutate(#name = str_remove_all(name, "school district.*"), 
         name = str_squish(name))
```

```{r}
michigan_nces <- nces %>% select(-c(`State District ID`, City)) %>% 
  left_join(state_name_df) %>% select(-state) %>% rename(state = state.name) %>% filter(state == "Michigan") %>% 
  mutate(name = str_squish(name)) %>% 
  select(nces_original_name, name, student)  
```

```{r}
michigan_acfrs %>% left_join(michigan_nces) %>% filter(is.na(student))
```


